name: Check PostHog Insight

on:
  workflow_dispatch:  # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
  schedule:
    - cron: '*/5 * * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚

jobs:
  check-insight:
    runs-on: ubuntu-latest
    steps:
      - name: Run script
        env:
          POSTHOG_URL: https://posthog.wachanga.com/      # âš ï¸ Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸ Ğ½Ğ° ÑĞ²Ğ¾Ğ¹ URL
          INSIGHT_ID: 'F293UKTa'                           # âš ï¸ Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸ Ğ½Ğ° ID ÑĞ²Ğ¾ĞµĞ³Ğ¾ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ°
          API_KEY: ${{ secrets.API_KEY }}            # ĞĞµ Ğ¼ĞµĞ½ÑĞ¹ â€” Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸Ğ· ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  # ĞĞµ Ğ¼ĞµĞ½ÑĞ¹
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  # ĞĞµ Ğ¼ĞµĞ½ÑĞ¹
        run: |
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ğ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          pip3 install requests

          # Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚
          python3 -c "
          import requests
          import json
          import os
          from datetime import datetime

          # === Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² ===
          POSTHOG_URL = os.getenv('POSTHOG_URL')
          INSIGHT_ID = os.getenv('INSIGHT_ID')
          API_KEY = os.getenv('API_KEY')
          TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')
          TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

          # Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
          STATE_FILE = '/tmp/state.json'

          def send_telegram(text):
              url = f'https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage'
              data = {'chat_id': TELEGRAM_CHAT_ID, 'text': text, 'parse_mode': 'HTML'}
              requests.post(url, data=data)

          try:
              # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· PostHog
              url = f'{POSTHOG_URL}/api/projects/@current/insights/{INSIGHT_ID}/'
              headers = {'Authorization': f'Bearer {API_KEY}'}
              params = {'refresh': 'true'}
              response = requests.get(url, headers=headers, params=params)

              if response.status_code != 200:
                  send_telegram('ğŸ”´ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· PostHog')
                  exit()

              data = response.json()
              series = data['result'][0]['data']
              if not series:
                  send_telegram('ğŸŸ¡ ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞµ')
                  exit()

              # Ğ‘ĞµÑ€ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ (ÑĞµĞ¹Ñ‡Ğ°Ñ)
              current_value = series[-1]

              # Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
              last_value = None
              if os.path.exists(STATE_FILE):
                  try:
                      with open(STATE_FILE, 'r') as f:
                          last_value = json.load(f)['value']
                  except:
                      pass

              # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
              with open(STATE_FILE, 'w') as f:
                  json.dump({'value': current_value, 'time': datetime.now().isoformat()}, f)

              # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº â€” Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼
              if last_value is None:
                  print('ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº. ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼.')
                  exit()

              # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ >10%
              if current_value < last_value * 0.9:  # Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 10%
                  percent_drop = (1 - current_value / last_value) * 100
                  message = f'''
ğŸš¨ <b>Ğ¡Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸!</b>
ğŸ“‰ Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ° Ğ² PostHog ÑƒĞ¿Ğ°Ğ»Ğ° Ğ½Ğ° <b>{percent_drop:.1f}%</b>
ğŸ”¢ Ğ‘Ñ‹Ğ»Ğ¾: {last_value:.3f}
ğŸ”¢ Ğ¡Ñ‚Ğ°Ğ»Ğ¾: {current_value:.3f}

ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ: {datetime.now().strftime('%H:%M:%S')}
                  '''
                  send_telegram(message)

          except Exception as e:
              send_telegram(f'ğŸ”´ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°: {str(e)}')
          "
